# LOGOS_ENVELOPE_SPEC_v1 ‚Äî –ü—Ä–æ—Ç–æ–∫–æ–ª —Å–æ–æ–±—â–µ–Ω–∏–π Logos (Envelope-first)

**–°—Ç–∞—Ç—É—Å:** üìã DRAFT  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 2025-12-18  
**–¶–µ–ª—å:** –µ–¥–∏–Ω—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π `Human ‚Üî Logos`, `Logos ‚Üî Logos`, `Logos ‚Üî Tools`, –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ LLM/–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.

---

## 0) –¢–µ—Ä–º–∏–Ω—ã

- **Logos**: –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å —Å on-chain –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å—é `did:logos:{HANDLE}`.
- **Owner**: –≤–ª–∞–¥–µ–ª–µ—Ü Logos (on-chain `LogosAccount.owner()`).
- **Agent**: –∫–ª—é—á Logos (on-chain `LogosAccount.agent()`), –∫–æ—Ç–æ—Ä—ã–º Logos –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã.
- **Envelope**: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è/—Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ + –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ + –ø–æ–¥–ø–∏—Å—å(–∏).
- **Receipt**: –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–π —á–µ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≤ `RECEIPT_SPEC_v1`).
- **Capability Token**: —Ç–æ–∫–µ–Ω –ø–æ–ª–Ω–æ–º–æ—á–∏–π –Ω–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–≤ `CAPABILITY_TOKEN_SPEC_v1`).

---

## 1) –ü—Ä–∏–Ω—Ü–∏–ø—ã (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—É)

- **Identity-first**: on-chain ‚Äî source of truth –¥–ª—è –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏ –∏ –∫–ª—é—á–µ–π.
- **No trust in servers**: –¥–æ–≤–µ—Ä–∏–µ —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ –ø–æ–¥–ø–∏—Å–∏ + on-chain –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏.
- **Forkability**: –ª—é–±–æ–π –º–æ–∂–µ—Ç –ø–æ–¥–Ω—è—Ç—å runtime, –Ω–æ –ø—Ä–æ—Ç–æ–∫–æ–ª –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.
- **No manual moderation**: –ø—Ä–∞–≤–∞/–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—ã—Ä–∞–∂–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞–ª—å–Ω–æ (capabilities, –ª–∏–º–∏—Ç—ã), –∞ –Ω–µ ‚Äú–∞–¥–º–∏–Ω–æ–º‚Äù.

---

## 2) –§–æ—Ä–º–∞—Ç LogosEnvelope

### 2.1 Schema (–≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å)

```json
{
  "v": "logos-envelope/1",
  "type": "chat.request",
  "id": "uuid",
  "ts": 1734470400000,
  "nonce": 1734470400000,
  "chain": { "chainId": 8453 },
  "logos": {
    "handle": "GUVUIK",
    "did": "did:logos:GUVUIK",
    "account": "0x...",
    "registry": "0x..."
  },
  "auth": {
    "scheme": "owner-session",
    "sessionId": "uuid"
  },
  "payload": {},
  "context": {},
  "hash": {
    "alg": "keccak256-jcs",
    "value": "0x..."
  },
  "signatures": [
    {
      "role": "agent",
      "scheme": "eip191-bytes32",
      "signer": "0x...",
      "signature": "0x..."
    }
  ],
  "receipt": {}
}
```

### 2.2 –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è

- **`v`**: —Å—Ç—Ä–æ–∫–∞ –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞. –ó–Ω–∞—á–µ–Ω–∏–µ: `logos-envelope/1`.
- **`type`**: —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–º. —Ä–∞–∑–¥–µ–ª 3).
- **`id`**: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è (UUID v4).
- **`ts`**: timestamp (ms) –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è.
- **`nonce`**: —á–∏—Å–ª–æ –¥–ª—è anti-replay (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –º–æ–∂–Ω–æ = `ts`, –Ω–æ MUST –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –≤ —Ä–∞–º–∫–∞—Ö `(signer, type)` –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –æ–∫–Ω–µ).
- **`chain.chainId`**: `8453` (Base mainnet) –∏–ª–∏ –∏–Ω–æ–π.
- **`logos.handle`**: Base36 uppercase 4‚Äì10.
- **`logos.did`**: `did:logos:{HANDLE}` (–≤ MVP), –¥–∞–ª—å–Ω–µ–π—à–µ–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ.
- **`logos.account`**: –∞–¥—Ä–µ—Å `LogosAccount` (controller).
- **`logos.registry`**: –∞–¥—Ä–µ—Å `NameRegistry`.
- **`payload`**: –ø–æ–ª–µ–∑–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞.
- **`hash`**: —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è **unsigned envelope** (—Å–º. —Ä–∞–∑–¥–µ–ª 4).
- **`signatures[]`**: –ø–æ–¥–ø–∏—Å–∏ (–¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ Logos –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –ø–æ–¥–ø–∏—Å—å `role=agent`).

### 2.3 –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è

- **`auth`**: —Å–ø–æ—Å–æ–±—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ (owner-session, owner-signature, etc.).
- **`context`**: –∫–æ–Ω—Ç–µ–∫—Å—Ç/–∏—Å—Ç–æ—Ä–∏—è/–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å —É—Ä–µ–∑–∞–Ω/—Å—É–º–º–∞—Ä–∏–∑–æ–≤–∞–Ω).
- **`receipt`**: —á–µ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–º–∏–Ω–∏–º—É–º —Å–µ–π—á–∞—Å, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å–ø–µ–∫–µ).

---

## 3) –¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π (`type`)

### 3.1 Human ‚Üî Logos (MVP)

- **`chat.request`**: —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫ —Å–≤–æ–µ–º—É Logos.
- **`chat.response`**: –æ—Ç–≤–µ—Ç Logos –≤–ª–∞–¥–µ–ª—å—Ü—É.

### 3.2 Logos ‚Üî Logos (–±—É–¥—É—â–µ–µ)

- `a2a.request`, `a2a.response`, `a2a.notify`

### 3.3 Logos ‚Üî Tools (–±—É–¥—É—â–µ–µ)

- `tool.invoke`, `tool.result`

---

## 4) –ö–∞–Ω–æ–Ω–∏–∑–∞—Ü–∏—è –∏ messageHash

### 4.1 –ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ

–ß—Ç–æ–±—ã –ø–æ–¥–ø–∏—Å–∏ –±—ã–ª–∏ **–≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã** —É –ª—é–±—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, —Ö–µ—à –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –ø–æ –∫–∞–Ω–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É JSON.

### 4.2 –ù–æ—Ä–º–∞—Ç–∏–≤: JCS (RFC 8785)

- **MUST** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JSON Canonicalization Scheme (JCS / RFC 8785) –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–∞.
- –°—Ç—Ä–æ–∫–∞, –ø–æ–ª—É—á–µ–Ω–Ω–∞—è JCS, –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è `canonical_json`.

### 4.3 –ß—Ç–æ —Ö–µ—à–∏—Ä—É–µ—Ç—Å—è (unsigned envelope)

–î–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è `hash.value` –±–µ—Ä—ë—Ç—Å—è envelope **–±–µ–∑ –ø–æ–ª–µ–π**:
- `hash`
- `signatures`

–¢–æ –µ—Å—Ç—å:
1) –±–µ—Ä—ë–º –∏—Å—Ö–æ–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç envelope
2) —É–¥–∞–ª—è–µ–º `hash` –∏ `signatures`
3) –∫–∞–Ω–æ–Ω–∏–∑–∏—Ä—É–µ–º JCS
4) —Å—á–∏—Ç–∞–µ–º `keccak256(utf8_bytes(canonical_json))`

### 4.4 –ê–ª–≥–æ—Ä–∏—Ç–º

- **`hash.alg`**: `keccak256-jcs`
- **`hash.value`**: `0x` + 32 –±–∞–π—Ç–∞

---

## 5) –ü–æ–¥–ø–∏—Å–∏

### 5.1 –û–±—â–∞—è –º–æ–¥–µ–ª—å

Envelope –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–µ–π.

–ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç `signatures[]`:

```json
{
  "role": "agent",
  "scheme": "eip191-bytes32",
  "signer": "0x...",
  "signature": "0x..."
}
```

### 5.2 –°—Ö–µ–º–∞ –ø–æ–¥–ø–∏—Å–∏ `eip191-bytes32` (ethers.js —Å–æ–≤–º–µ—Å—Ç–∏–º–æ)

**Signing input:** `hash.value` –∫–∞–∫ bytes32 (32 –±–∞–π—Ç–∞).

- –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –∏–º–µ–Ω–Ω–æ bytes:
  - `signature = wallet.signMessage(getBytes(hash.value))`

**Verification:**
- `recovered = ethers.verifyMessage(getBytes(hash.value), signature)`
- `recovered` MUST —Ä–∞–≤–Ω—è—Ç—å—Å—è `signer` (lowercase compare).

### 5.3 –†–æ–ª–∏ –ø–æ–¥–ø–∏—Å–µ–π

- **`role=agent`** (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è `chat.response`):
  - signer MUST —Ä–∞–≤–Ω—è—Ç—å—Å—è on-chain `LogosAccount.agent()`.
- **`role=owner`** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤ v1):
  - signer MUST —Ä–∞–≤–Ω—è—Ç—å—Å—è on-chain `LogosAccount.owner()`.

---

## 6) Binding –∫ on-chain identity (–ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Äú—ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ Logos X‚Äù)

–î–ª—è –ª—é–±–æ–≥–æ envelope, —Å–æ–¥–µ—Ä–∂–∞—â–µ–≥–æ `logos.handle`:

1) `account = NameRegistry.resolve(handle)`  
2) `agent = LogosAccount(account).agent()`  
3) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å—å `role=agent`, –∏–∑–≤–ª–µ—á—å `recovered`  
4) **VALID** –µ—Å–ª–∏ `recovered == agent` AND `logos.account == account`

–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: `logos.did` –≤ MVP –≤—ã–≤–æ–¥–∏—Ç—Å—è –∏–∑ handle, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ `account/agent`.

---

## 7) MVP payload‚Äô—ã

### 7.1 `chat.request.payload`

```json
{
  "message": "–ü—Ä–∏–≤–µ—Ç!",
  "previous": [
    { "role": "user", "content": "..." },
    { "role": "assistant", "content": "..." }
  ]
}
```

–ü—Ä–∞–≤–∏–ª–∞:
- `message` –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
- `previous` –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω (—Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å N –∏/–∏–ª–∏ —Å—É–º–º–∞—Ä–∏–∑–æ–≤–∞—Ç—å)

### 7.2 `chat.response.payload`

```json
{
  "message": "–ü—Ä–∏–≤–µ—Ç! –Ø GUVUIK ...",
  "llm": {
    "model": "gpt-4o-mini",
    "tokens": 150
  }
}
```

---

## 8) Anti-replay –∏ –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å–æ–æ–±—â–µ–Ω–∏–π

### 8.1 –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- `id` MUST –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º (UUID).
- `ts` MUST –±—ã—Ç—å –≤ —Ä–∞–∑—É–º–Ω–æ–º –æ–∫–Ω–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬±10 –º–∏–Ω—É—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤).
- `nonce` MUST –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –≤ —Ä–∞–º–∫–∞—Ö `(signer, type)` –Ω–∞ –æ–∫–Ω–µ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 24 —á–∞—Å–∞).

### 8.2 –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è MVP

–í MVP –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ:
- `nonce = ts`
- —Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–∞–º—è—Ç–∏/Redis `seenNonces[signer][nonce]` –Ω–∞ 24 —á–∞—Å–∞.

---

## 9) –û—à–∏–±–∫–∏ (–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–¥—ã)

- **`400 invalid_envelope`**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è / –Ω–µ–≤–µ—Ä–Ω—ã–µ —Ç–∏–ø—ã
- **`401 auth_required`**: –Ω–µ—Ç `auth` –¥–ª—è owner-–∑–∞–ø—Ä–æ—Å–∞
- **`403 not_owner`**: owner-session –∏–ª–∏ owner-signature –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç `LogosAccount.owner()`
- **`409 replay_detected`**: nonce/id —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å
- **`422 signature_invalid`**: –ø–æ–¥–ø–∏—Å—å –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é

---

## 10) Acceptance Criteria (–¥–ª—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞)

- [ ] Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `chat.response` –∫–∞–∫ `LogosEnvelope` —Å `hash + signatures[agent]`
- [ ] Frontend —É–º–µ–µ—Ç –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å envelope: `hash` + `agent signature`
- [ ] –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å `chat.request` –∫ —á—É–∂–æ–º—É handle (403)
- [ ] Envelope –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ on-chain `NameRegistry + LogosAccount`

---

## 11) –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `LOGOS_ECOSYSTEM_SPECIFICATION.md` (—Å–ª–æ–π 7: –ø—Ä–æ—Ç–æ–∫–æ–ª—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏)
- `ADR-004-two-key-architecture.md`
- `ADR-005-logos-agent-architecture.md`
- `ADR-006-logos-runtime-identity-binding.md`


